<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head.ejs', {page: "settings"}); %>

<body class="bg-gray-100">
  <%- include('../partials/nav.ejs', {active: "settings", user, loggedIn, noPost: true}); %>

  <main class="container mx-auto px-4 mt-24 md:mt-16">
    <h1>Settings</h1>
    <section class="mt-2 mb-5 bg-white p-5 rounded-xl">
      <h1 class="font-bold text-2xl text-gray-700 mb-4">Account</h1>
      <form id='username-form'>
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 my-2 rounded relative" style="display: none;" id='name-alert' role="alert">
          <strong class="font-bold">Error changing username!</strong>
          <span class="block sm:inline" id='name-msg'>Something seriously bad happened.</span>
        </div>
        <label for="username">Username: </label>
        <input
          class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:shadow-outline-blue focus:border-blue-300 focus:z-10 sm:text-sm sm:leading-5"
          name="username" type='text' id="username" value="<%= user.name %>">
        <p class="my-2 text-gray-500">Note that changing your username may have <a href='#'>undesirable
            consequences</a></p>
        <input class="block p-2 text-white bg-indigo-500 rounded my-2 cursor-pointer" type="submit" value="Update">
      </form>
    </section>

    <section class="mt-2 mb-5 bg-white p-5 rounded-xl">
      <h1 class="font-bold text-2xl text-gray-700 mb-4">Danger zone</h1>
      <details class='text-gray-700'>
        <summary>I want to delete my account</summary>
        <form id='delete-form'>
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 my-2 rounded relative" style="display: none;" id='delete-alert' role="alert">
            <strong class="font-bold">Error changing username!</strong>
            <span class="block sm:inline" id='delete-msg'>Something seriously bad happened.</span>
          </div>
          <input type="checkbox" name="agree" id="agree"><label class='ml-2' for="agree">I understand the severity of this action, and that accounts cannot be recovered.</label>
          <input id='delete-submit' class="block p-2 text-white bg-red-200 rounded my-2 cursor-pointer" type="submit" value="Delete <%= user.name %>" disabled>
        </form>
      </details>
    </section>

  </main>
</body>
<script>
    var usernameForm = document.getElementById('username-form')
    usernameForm.addEventListener('submit', e => {
      e.preventDefault()
      var newUsername = document.getElementById('username').value
      console.log(newUsername)
      changeName(newUsername)
    })


    var deleteForm = document.getElementById('delete-form')
    var agree = document.getElementById('agree')
    var deleteSubmit = document.getElementById('delete-submit')
    agree.addEventListener('input', e=>{
      if(agree.checked){
        deleteSubmit.disabled = false
        deleteSubmit.classList.replace('bg-red-200', 'bg-red-500')
      } else {
        deleteSubmit.disabled = true
        deleteSubmit.classList.replace('bg-red-500', 'bg-red-200')
      }
    })

    deleteForm.addEventListener('submit', e => {
      e.preventDefault()

      deleteAccount()
    })
    
    async function changeName(newUsername) {
      var res = await fetch('/update-username', {
        method: 'POST',
        redirect: 'follow',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ username: newUsername })
      })
      var data = await res.json()
      if (data.ok) {
        document.location.href = '/'
      } else {
        document.getElementById('name-alert').style.display = 'block'
        document.getElementById('name-msg').innerText = data.error
      }
    }

    
    async function deleteAccount() { //todo
      var res = await fetch('/delete-account', {
        method: 'POST',
        redirect: 'follow',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      var data = await res.json()
      if (data.ok) {
        document.location.href = '/'
      } else {
        document.getElementById('delete-alert').style.display = 'block'
        document.getElementById('delete-msg').innerText = data.error
      }
    }
</script>

</html>